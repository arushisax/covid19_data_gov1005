---
title: "Stringency of Country Responses"
author: "Rebecca Xi"
date: "4/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(readr)
library(rvest)
library(janitor)
library(skimr)
library(sf)
library(maps)
library(tibble)
library(countrycode)
library(gganimate)
library(d3rain)
```

```{r oxford data, include=FALSE}

# https://github.com/OxCGRT/covid-policy-tracker

# Import and clean Oxford Covid-Policy-Tracker data. Both sets are downloaded
# here, but we will likely only need the first (the second is for our own
# reference, as it contains detailed explanatory notes).

oxford <- read.csv(url("https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv")) %>% 
  mutate(new_date = as.Date(as.character(Date), format = "%Y%m%d"))

# oxford_detailed <- read.csv(url("https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest_withnotes.csv"))
```

FYI: (see https://www.bsg.ox.ac.uk/sites/default/files/2020-04/BSG-WP-2020-031-v4.0_0.pdf for more info)

S1-S6 are further classified as either “targeted” (meaning they apply only in a
geographically concentrated area) or “general” (meaning they apply throughout the
entire jurisdiction).

### S1: School closing (Record closings of schools and universities)
0 - no measures
1 - recommend closing
2 - require closing

### S2: Workplace closing (Record closings of workplaces)
0 - No measures
1 - recommend closing
2 - require closing

### S3: Cancel public events (Record cancelling public events)
0 - No measures
1 - Recommend cancelling
2 - Require cancelling

### S4: Close public transport (Record closing of public transport)
0 - No measures
1 - Recommend closing
2 - Require closing

### S5: Public info campaigns (Record presence of public info campaigns)
0 -No COVID-19 public information campaign
1 - COVID-19 public information campaign

### s6: Restrictions on internal movement (Record restrictions on internal movement)
0 - No measures
1 - recommend movement restriction
2 - restrict movement

### s7: International travel controls (Record restrictions on international travel)
0 - No measures
1 - Screening
2 - Quarantine on high-risk regions
3 - Ban on high-risk regions

### s8: Fiscal measures (What economic stimulus policies are adopted?)
Value of fiscal stimuli, including spending or tax cuts (in USD)

### s9: Monetary measures (What monetary policy interventions?)
Value of interest rate (in %)

### s10: Emergency investment in healthcare (Short-term spending on, e.g, hospitals, masks,etc)
Value of new short-term spending on health (in USD)

### s11: Investment in vaccines (Announced public spending on vaccine development)
Value of investment (in USD)

### S12: Testing policy (Who can get tested)
0 - No testing policy
1 - only testing those who both (a) have symptoms, and (b) meet specific criteria (eg key workers, admitted to hospital, came into contact with a known case, returned from overseas)
2 - testing of anyone showing COVID19 symptoms 
3 - open public testing (eg “drive through” testing available to asymptomatic people)

###S13: Contact tracing (Are governments doing contact tracing)
0 - no contact tracing
1 - limited contact tracing – not done for all cases
2 - comprehensive contact tracing – done for all cases


```{r JHU data, include=FALSE}

# Read in and clean global JHU CSSE data. Update the date format and create an
# increment column for the confirmed cases across the globe

# Confirmed

global_confirmed <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")) %>% 
  clean_names() %>% 
  pivot_longer(cols = -c(province_state, country_region, lat, long), names_to = "date", values_to = "confirmed") %>%
  select(country_region, date, confirmed)

global_confirmed <- global_confirmed %>% 
  mutate(sep_date = sub("x", "", date)) %>%
  mutate(new_date = as.Date(sep_date, format = "%m_%d_%y")) %>%
  mutate(helper = c(
    confirmed[1],
    confirmed[1:(nrow(global_confirmed) - 1)])
  ) %>%
  mutate(increment = confirmed - helper) %>%
  group_by(country_region)

# Deaths

global_deaths <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")) %>% 
  clean_names() %>%
  pivot_longer(cols = -c(province_state, country_region, lat, long), names_to = "date", values_to = "deaths") %>%
  select(country_region, date, deaths)

global_deaths <- global_deaths %>% 
  mutate(sep_date = sub("x", "", date)) %>%
  mutate(new_date = as.Date(sep_date, format = "%m_%d_%y")) %>%
  mutate(helper = c(
    deaths[1],
    deaths[1:(nrow(global_deaths) - 1)])
  ) %>%
  mutate(increment = deaths - helper) %>%
  group_by(country_region)

# Recovered

global_recovered <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")) %>% 
  clean_names() %>%
  pivot_longer(cols = -c(province_state, country_region, lat, long), names_to = "date", values_to = "recovered") %>%
  select(country_region, date, recovered)

global_recovered <- global_recovered %>% 
  mutate(sep_date = sub("x", "", date)) %>%
  mutate(new_date = as.Date(sep_date, format = "%m_%d_%y")) %>%
  mutate(helper = c(
    recovered[1],
    recovered[1:(nrow(global_recovered) - 1)])
  ) %>%
  mutate(increment = recovered - helper) %>%
  group_by(country_region)

# Join JHU data 

covidGlobal <- global_confirmed %>%
  inner_join(
    global_deaths, 
    by = c("country_region", "new_date"), 
    suffix = c("_confirmed", "_deaths")
  ) %>%
  inner_join(
    global_recovered, 
    by = c("country_region", "new_date"), 
    suffix = c("_confirmed", "_recovered")
  ) %>%
  select(
    country_region, 
    new_date, 
    confirmed, 
    increment_confirmed, 
    deaths, 
    increment_deaths, 
    recovered, 
    increment
  ) %>% 
  rename(
    Country = country_region
  )

# Use countrycode package to standardize all country names, for easy joining
# with Oxford data (which comes with CountryCode column)

covidGlobal <- covidGlobal %>% 
  mutate(CountryCode = countrycode(Country, origin = 'country.name', destination = 'iso3c')) %>% 
  filter(Country != "Diamond Princess", Country != "MS Zaandam")

# Diamond Princess, Kosovo, MS Zaandam
```

```{r final data, include=FALSE}

# Join Oxford and JHU global data and clean

stringency <- oxford %>% 
  full_join(covidGlobal, by = c("CountryCode", "new_date")) %>% 
  filter(!is.na(confirmed)) %>% 
  select(
    Country, 
    CountryCode, 
    new_date, 
    S1_School.closing,
    S1_IsGeneral,
    S2_Workplace.closing,
    S2_IsGeneral,
    S3_Cancel.public.events,
    S3_IsGeneral,
    S4_Close.public.transport,
    S4_IsGeneral,
    S5_Public.information.campaigns,
    S5_IsGeneral,
    S6_Restrictions.on.internal.movement,
    S6_IsGeneral,
    S7_International.travel.controls,
    S8_Fiscal.measures,
    S9_Monetary.measures,
    S10_Emergency.investment.in.health.care,
    S11_Investment.in.Vaccines,
    S12_Testing.framework,
    S13_Contact.tracing,
    StringencyIndexForDisplay,
    confirmed,
    increment_confirmed,
    deaths,
    increment_deaths,
    recovered,
    increment
    )
```

```{r regions, echo=FALSE}

regions <- read.csv(url("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv")) %>% 
  select(name, region, sub.region) %>% 
  rename(Country = name)

# joining with existing dataset

stringency_regions <- stringency %>% 
  full_join(regions, by = "Country")
```

```{r visualizations, echo=FALSE}

# S1-S7

# S8-S11

# S12-13

# Country level (compare 2-3 countries side by side)

usa <- stringency %>% 
  filter(CountryCode == "USA") %>% 
  ggplot(aes(x = new_date)) +
    geom_line(aes(y = confirmed, color = "Confirmed")) +
    geom_line(aes(y = deaths, color = "Deaths")) +
    geom_line(aes(y = recovered, color = "Recovered")) +
    transition_reveal(new_date) +
    scale_color_manual(
      "", 
      breaks = c("Confirmed", "Deaths", "Recovered"),
      values = c("black", "darkred", "steelblue")
    ) +
    labs(
      title = "Spread and Stringency Response in USA",
      x = "Time",
      y = "Count"
    ) +
    scale_x_date(
      date_breaks = "1 week", 
      date_labels = "%b %d"
    ) 
usa
  
# Country-level


  
# Countries within regions, region-wide trends



# Compare regions

# Compare sub-regions
  


```



